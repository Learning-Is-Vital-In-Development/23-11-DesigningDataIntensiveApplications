### 지식, 진실, 그리고 거짓말


#### 진실은 다수결로 결정된다

분산 시스템은 종족수, 즉 노드들 사이의 투표에 의존한다.
정족수는 보통 과반수를 기준으로 한다.

#### 리더와 잠금

리더 노드가 죽었다고 선언되어 새로운 리더 노드를 선출했을 때, 기존 리더 노드가 살아난 뒤에도 권한을 행사하려한다면 문제를 유발할 수 있다.

> [예시] 저장 서비스에 있는 어떤 파일을 한 번에 클라이언트 하나씩만 접근하는 프로그램을 만들고, 클라이언트가 그 파일에 접근하기 전에 잠금 서비스로부터 임차권(lease)을 얻도록 해서 기능을 구현한 경우
> ![image](https://github.com/rachel5004/23-11-DesigningDataIntensiveApplications/assets/75432228/4f99bce4-4e35-4dca-b3b0-8de6e8c8bc0c)
> 결과적으로 클라이언트들의 쓰기가 충돌되고 파일이 오염된다


#### 펜싱 토큰(fencing token)

위처럼 자신이 리더라고 잘못 믿고있는 노드가 시스템을 방해할 수 없도록 하는 단순한 기법으로 펜싱(fencing) 이 있다.

잠금 서버가 임차권(lease)을 승인할 때마다 펜싱 토큰(fencing token) 도 반환하도록 하자.<br>
스토리지는 자신이 처리한 쓰기작업의 토큰번호(34)를 기억해뒀다가 오래된 토큰(33)이 올 경우 쓰기를 거부한다.

>  클라이언트1은 토큰이 만료되어 쓰기가 거부된다.
> ![image](https://github.com/rachel5004/23-11-DesigningDataIntensiveApplications/assets/75432228/07591289-7965-402e-9324-8359c67a12d3)

클라이언트에서 토큰을 검증할 수도 있지만 클라이언트는 믿을 수 없기 때문에 서버에서 토큰을 확인하는 것이 좋다.

#### 비잔틴 결함(Byzantine fault)

펜싱 토큰은 부주의에 의한 오류에 빠진 노드를 감지하고 차단할 수 있다. 하지만 고의로 가짜 토큰을 보내는 노드에는 취약하다.

노드가 받지 않은 메시지를 받았다고 하는 등의 "거짓말"을 하는 것을 **비잔틴 결함(Byzantine fault)**이라고 하며,<br>
이런 신뢰할 수 없는 환경에서 합의에 도달하는 문제를 **비잔틴 장군 문제(Byzantine Generals Problem)** 라고 한다.

비잔틴 내결함성을 가지는 프로토콜을 만드는 것은 매우 복잡하며 비용이 크다.

