# 복제 part.2 (리더 없는 복제)

일부 데이터 저장소 시스템은 리더의 개념을 버리고 모든 복제 서버가 클라이언트로부터 쓰기를 직접 받을 수 있게 허용하는 접근 방식을 사용하기도 한다. 리악, 카산드라, 볼드모트는 다이나모에서 영감을 얻은 리더 없는 복제 모델의 오픈소스 데이터스터다. 이런 종류의 데이터베이스를 다이나모 스타일이라 한다.

여기서 다이나모는 AWS 가 제공하는 다이나모DB 와는 완전히 다르다.

## 노드가 다운됐을 때 데이터베이스에 쓰기

세 개의 복제 서버를 가진 데이터베이스가 있고 복제 서버 중 하나를 사용할 수 없다고 가정해보자. 리더 기반 설정에서 쓰기 처리를 계속하려면 장애 복구를 실행해야 한다.

반면 리더 없는 설정에서는 장애 복구가 필요하지 않다. 클라이언트는 쓰기를 세 개의 모든 복제 서버에 병렬로 전송한다. 사용 가능한 두 개의 복제 서버는 쓰기를 받았지만 사용 불가능한 복제 서버는 쓰기를 놓쳤다. 클라이언트는 복제 서버 중 하나가 쓰기를 놓친 사실을 단순히 무시한다.

이제 사용할 수 없었던 노드가 다시 온라인 상태가 되고 클라이언트가 이 노드에서 읽기를 시작한다고 생각해보자. 노드가 다운된 동안 발생한 모든 쓰기는 해당 노드에서 누락됐다. 따라서 클라이언트는 해당 노드에서 데이터를 읽는다면 응답으로 오래된(outdated) 값을 얻을 수 있다.

이 문제를 해결하기 위해 클라이언트가 데이터베이스에서 읽을 때 하나의 복제 서버로 요청을 보내지 않고 **읽기 요청을 병렬로 여러 노드에 전송**한다. 그러면 클라이언트는 여러 노드에서 다른 응답을 받을 수 있는데 이때 버전 숫자를 사용해 어떤 값이 최신 내용인지 결정한다.

### 읽기 복구와 안티 엔트로피

#### 읽기 복구

클라이언트가 여러 노드에서 병렬로 읽기를 수행하면 오래된 응답을 감지할 수 있다. 이런 경우 클라이언트는 오래된 값을 가진 노드에게 새로운 값을 다시 기록한다. 이 접근 방식은 값을 자주 읽는 상황에 적합하다.

#### 안티 엔트로피 처리

추가적으로 일부 데이터스토어는 백그라운드 프로세스를 두고 복제 서버 간 데이터 차이를 지속적으로 찾아 누락된 데이터를 하나의 복제 서버에서 다른 서버로 복사한다. 리더 기반 복제에서의 복제 로그와 달리 이 안티 엔트로피 처리는 특성 순서로 쓰기를 복사하기 때문에 데이터가 복사되기까지 상당한 지연이 있을 수 있다.

### 읽기와 쓰기를 위한 정족수

n 개의 복제 서버가 있을 때 모든 쓰기는 w 개의 노드에서 성공해야 쓰기가 확정되고 모든 읽기는 최소한 r 개의 노드에 질의해야 한다. w + r > n 이면 읽을 때 최신 값을 얻을 것으로 기대한다. 최소한 r 개의 노드 중 하나에서 최신 값을 읽을 수 있기 때문이다. 이런 r 과 w 를 따르는 읽기와 쓰기를 정족수 읽기와 쓰기라고 부른다.

## 정족수 일관성의 한계



## 느슨한 정족수와 암시된 핸드오프

## 동시 쓰기 감지
