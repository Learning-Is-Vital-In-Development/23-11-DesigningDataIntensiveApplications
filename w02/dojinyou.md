# 데이터 모델과 질의 언어(관계형 모델과 문서 모델)

데이터 저장과 질의를 위한 관계형, 문서형, 그래프형 데이터 모델들에 대해서 비교해본다.

# 관계형 모델과 문서 모델

가장 잘 알려진 데이터 모델은 관계형 모델이다. 관계형 모델은 테이블로 구성되고 순서 없는 튜플의 모음이다. 이러한 관계형 모델은 오랜 시간 우위를 가졌다. 주된 사용 사례는 트랜잭션 처리나 일괄 처리의 영역이었다.

## NoSQL의 탄생

NoSQL의 원동력

- 매우 높은 쓰기 처리량 달성이 관계형 모델보다 쉽다.
- 오픈 소스 소프트웨어를 선호
- 관계형 모델과 다른 특수한 질의 지원
- 동적이고 풍부한 스키마 데이터 모델

## 객체 관계형 불일치

오늘날 어플리케이션은 대부분 객체지향 프로그래밍 언어로 개발한다. 이것은 관계형 데이터 모델과의 차이를 만들어내고 이를 해결하기 위해서는 변환을 위한 전환 계층을 필요로 한다. 이런 모델 사이의 분리를 임피던스 불일치(impedance mismatch)라고 부른다.

문서의 형태는 JSON으로 표현하는 것이 매우 적합하다. 다중 테이블 스키마보다 더 나은 지역성을 가진다. 관계형에서는 여러 관계를 조합해야 하지만 JSON는 이런 데이터들이 한 문서에 집약되어 있다.

## 다대일과 다대다 관계

관계형 데이터베이스는 데이터 중복을 피한다. 대신 식별자를 공유한다. 이러한 공유는 관계형 모델에서는 유효하지만 문서 모델에서는 유효하지 않다. 문서 모델은 한 곳에 데이터를 집약적으로 관리하기 때문에 조인 기능을 약하게 지원한다. 하지만 이렇게 될 경우 데이터가 중복될 가능성이 있다.

## 문서 데이터베이스는 역사를 반복하고 있나?

문서 데이터베이스처럼 IMS도 일다다는 잘 표현했지만 다대다를 잘 표현하지 못 했고 조인도 지원하지 않았다. 개발자는 데이터를 중복할 지, 수동으로 해결할 지 결정해야 했다.

이러한 계층 모델의 한계를 극복하기 위한 두드러진 두 해결책은 관계형 모델과 네트워크 모델이다.

### 네트워크 모델

네트워크 모델은 코다실이라고 불리는 위원회에서 표준화 되어 코다실 모델이라고도 불린다. 트리 구조에서 모든 레코드는 정확하게 하나의 부모가 있다. 레코드를 접근하기 위한 유일한 방법은 최상위 레코드에서부터 연속적으로 연결된 연결 경로를 따른 방법이고 이를 접근 경로라고 한다.

계층 모델과 네트워크 모델 모두, 원하는 데이터에 대한 경로가 없다면 어려운 상황에 놓인다. 접근 경로를 변경할 수 있지만 아주 많은 수작업 데이터베이스 질의 코드를 살펴봐야하고 새로운 접근 경로를 다루기 위해 재작성해야 한다.

### 관계형 모델

관계형 모델은 알려진 모든 데이터를 배치하는 일을 한다. 특정 데이터를 읽기 위한 복잡한 접근 경로는 없다. 임의의 조건에 맞는 일부 혹은 전체 데이터를 읽고 일부 칼럼을 키로 지정해 일치하는 로우를 읽을 수 있다.

질의 최적화기가 질의를 어떤 순서로 실행할지 어떤 색인을 사용할 지 모두 결정한다. 이것이 접근경로이고 따라서 개발자는 따로 생각할 것이 없다.

### 문서 데이터베이스와 비교

문서 데이터베이스는 별도 테이블이 아닌 상위 레코드 내 중첩 레코드로 일다 대 관계를 정의한다. 하지만 다대 다 관계를 표현할 때는 관계형 모델의 외래 키와 같이 고유한 식별자를 참조한다. 이를 문서 참조라고 부른다.

## 관계형 데이터베이스와 오늘날의 문서 데이터베이스

문서 데이터 모델을 선호하는 이유는 스키마의 유연성, 지역성에 기인한 더 나은 성능, 애플리케이션과  유사한 구조 때문이다.

### 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?

문서와 비슷한 구조인 일다 다 관계의 트리로 보통 한번에 트리 전체를 저장한다면 문서 모델을 사용하는 것이 좋다. 문서와 비슷한 구조를 여러 테이블로 나누어 찢는(shredding) 관계형 기법은 다루기 힘든 스키마와 불필요하게 복잡한 애플리케이션 코드를 발생시킨다.

문서 모델에는 문서 내 중첩 항목을 바로 참조할 수 없어서 계층 모델과 유사하게 접근해야 한다. 매우 깊은 중첩이 아니라면 일반적으로 문제가 되지 않는다.

미흡한 조인은 경우에 따라서 문제가 될 수도 안될 수도 있다. 애플리케이션에서 다대다 관계를 사용한다면 문서 모델은 매력이 떨어질 수 있다. 이 정규화로 조인이 줄어들지만 정합성을 유지하기 위해 다른 여러 가지 복잡한 장치를 도입해야 하기 때문이다. 또한 어플리케이션 레벨에서 조인은 조인에 특화된 DB보다 더 느릴 수 밖에 없다.

### 문서 모델에서의 스키마 유연성

문서 모델은 쓰기 과정에서 스키마를 강제하진 않는다. 하지만 읽기 과정에서는 어떠한 데이터의 형태를 기대하기 때문에 읽기 스키마(schema-on-read)다. 전통적인 관계형 모델에서는 쓰기 과정에서 스키마를 강하게 요구하는 쓰기 스키마(schema-on-write)이다.

접근 방식의 차이는 데이터를 변경하고자 할 때 극명하게 드러난다. 전통적인 관계형 모델의 경우에는 마이그레이션을 통해 스키마를 변경해야 한다. 이 과정이 특정 RDBMS에서는 오래 걸릴 수 있다. 하지만 문서 모델에서는 이전의 모델 형태에 대한 처리 코드만 포함하면 된다.

이러한 특정으로 문서 모델은 다음과 같은 상황에서 유리하다.

- 다른 여러 유형의 오브젝트가 있고 각 유형의 오브젝트별로 자체 테이블에 넣는 방법이 실용적이지 않을 때
- 데이터의 형태를 사용자가 제어할 수 없을 때

하지만 데이터의 형태가 예상되고 변경이 적은 경우 문서 모델을 적합하지 않을 수 있다.

### 질의를 위한 데이터 지역성

웹 페이지의 문서를 전체 로드해서 보여주는 것처럼 문서의 전체를 한번에 조회해야 할 때 저장소 지역성(storage locality)을 활용하면 성능 이점이 있다. 만약 여러 테이블로 나눠져 있다면 이를 전체 조회하기 위해서 다중 색인 검색이 필요하고 이때는 더 많은 디스크 탐색이 필요하게 된다. 지역성의 이점은 한번에 많은 문서를 읽어야 한다. 반대로 아주 부분만 읽게 된다면 오히려 전체 문서를 읽어야 하기 때문에 손해가 될 수 있다.

데이터의 지역성을 위한 데이터를 그룹화하는 개념은 단순히 문서 모델에서만 제공되지 않는다. 구글 스패너 데이터 베이스는 부모 테이블 내 테이블의 로우를 교차 배치되게끔 선언하는 스키마를 허용하여 지역성을 제공한다. 오라클은 다중 테이블 색인 클러스터 테이블(multi-table index cluster table)을 통해 동일한 개념을 제공한다. 빅테이블은 칼럼 패밀리(column-family) 개념이 지역성 관리와 유사한 목적이 있다.

> 스패너 테이블의 인터리브 처리된 테이블의 계층 정보
https://cloud.google.com/spanner/docs/schema-and-data-model?hl=ko#create-interleaved-tables
>

> 오라클 인덱스 클러스터 테이블
https://jungmina.com/821
>

### 문서 데이터베이스와 관계형 데이터베이스의 통합

관계형 데이터베이스는 XML을 지원하고 XML 문서는 지역적 수정과 내부 색인과 질의 기능을 포함하고 있다. JSON의 인기를 쫓아 관계형 데이터베이스에서도 비슷한 지원 기능을 추가할 가능성이 높다.

> MySQL은 5.7.8 버전부터 JSON 타입을 지원
https://dev.mysql.com/doc/refman/5.7/en/json.html
PostgreSQL 11 버전부터 JSON 타입을 지원
https://www.postgresql.org/docs/current/datatype-json.html
Oracle에서 12c버전부터 JSON 타입을 지원
https://www.appservgrid.com/documentation111/docs/rdbms12cr1/NEWFT/chapter12102.htm#BGBGADCC
>

문서형 데이터베이스는 리싱크DB는 질의 언어에서 관계형 조인을 지원한다. 몽고DB 드라이버는 자동으로 데이터 참조를 확인한다.

이렇듯 문서 데이터베이스와 관계형 데이터베이스는 서로의 기능을 지원하며 서로 비슷해져 가고 있다.
