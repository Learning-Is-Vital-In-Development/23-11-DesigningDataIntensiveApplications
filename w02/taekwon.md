# 02장. 데이터 모델과 질의언어(관계형 모델과 문서 모델)

복잡한 애플리케이션에서는 여러 API를 기반으로 만든 API 처럼 중간 단계를 더 둘 수 있지만 기본 개념은 여전히 동일하다. 각 계층은 명확한 데이터 모델을 제공해 하위 계층의 복잡성을 숨긴다.

데이터 모델은 그 위에서 소프트웨어가 할 수 있는 일과 할 수 없는 일에 지대한 영향을 주기 때문에 애플리케이션에 적합한 데이터 모델을 선택하는 작업은 상당히 중요하다.

## 관계형 모델과 문서 모델

오늘날 가장 잘 알려진 데이터 모델은 SQL이며, 데이터는(테이블) 관계(relation)로 구성되고 각 관계는 순서 없는 튜플(row) 모음이다.

관계형 테이터베이스의 근원은 비즈니스 데이터 처리에 있으며, 보통 트랜잭션 처리와 일괄처리로 오늘날의 관점에서는 일상적으로 수행되는 일이다. 관계형 모델의 목표는 정리된 인터페이스 뒤로 구현 세부 사항을 숨기는 것이다.

### NoSQL의 탄생

원래 `NoSQL` 은 오픈소스, 분산환경, 비관계형 데이터베이스 밋업용 인기 트위터 해시태그였다. 지금은 인기 있는 여러 데이터베이스 시스템과 #NoSQL 해시태그가 연관돼 있다. 그래서 NoSQL은 다시 거슬러 올라가 Not Only SQL로 재해석 됐다.

NoSQL 데이터 베이스 채택에는 다음과 같은 원동력이 있다.

- 대규모 데이터섹이나 매우 높은 쓰기 처리량 달성을 쉽게 할 수 있는 확장성의 필요.
- 무료 오픈소스 소프트웨어에 대한 선호도 확산
- 관계형 모델에서 지원하지 않는 특수 질의 동작
- 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

관계형데이터베이스가 폭넓은 다양함을 가진 비관계형 데이터스토어와 함께 사용될 것이며 이런 개념을 종종 `다중 저장소 지속성` 이라 한다.

### 객체 관계형 불일치

데이터를 관계형 테이블에 저장하려면 애플리케이션 코드와 데이터 베이스 모델 객체 사이에 전환 계층이 필요하며, 이런 모델 사이의 분리를 종종 `임피던스 불일치` 라고 부른다.

`액티브레코드` 나 `하이버네이트` 같은 객체 관계형 매핑 프레임워크는 전환 계층에 필요한 상용구 코드의 양을 줄이지만 두 모델 간의 차이를 완벽히 숨길 순 없다.

이력서 같은 데이터 구조는 모든 내용을 갖추고 있는 문서라서 JSON 표현에 매우 적합하다. JSON표현은 다중 테이블 스키마보다 더 나은 `지역성` 을 갖는다. JSON 표현에서는 모든 관련 정보가 한 곳에 있어 질의 하나로 충분하다. 즉 사용자 프로필에서 사용자에서 직위, 학력 기록, 연락처 정보로 대응되는 일대 다 관계는 의미상 데이터 트리 구조와 같으며 이 트리 구조는 JSON 표현에서 명시적으로 드러난다.

![image](https://github.com/Learning-Is-Vital-In-Development/23-11-DesigningDataIntensiveApplications/assets/71249347/7d51fe75-7429-4baf-a9e2-6041695150ba)

### 다대일과 다대다 관계

평문으로 저장이 가능한 칼럼에 대해 ID로 설정하는 경우의 이점은 무엇일까

드롭다운 리스트나 자동 완성 기능을 만들어 사용자가 선택하게 하는 데는 다음과 같은 장점이 있다.

- 프로필 간 일관된 스타일과 철자
- 모호함 회피
- 갱신의 편의성
- 현지화 지원
- 더 나은 검색

ID를 사용하는 장점으로 ID 자체는 아무런 의미가 없기 때문에 변경할 필요가 없다. 즉 식별 정보를 변경해도 ID는 동일하게 유지할 수 있다. 하지만 의미를 가지는 경우라면 언젠가 ID를 변경해야 할 수 도 있으며, 만일 정보가 중복돼 있을 경우 모든 중복 항목을 변경해야 하고 이는 쓰기 오버헤드와 불일치 위험이 있다.

중복된 데이터를 정규화하려면 `다대일` 관계가 필요한데 이는 관계형 데이터베이스의 조인을 활용하는 것이 일반적이다.

### 문서 데이터베이스는 역사를 반복하고 있나?

1970년대 비즈니스 데이터 처리를 위해 가장 많이 사용한 데이터베이스는 IBM의 정보 관리 시스템(`IMS`)이며, 계층 모델 이라 부르는 상당히 간단한 모델로 설계되었다. 문서 데이터베이스 처럼 IMS도 일대다 관계에서는 잘 동작하지만 다대다 관계 표현은 어려웠고 조인은 지원하지 않았다.

계층 모델의 한계를 해결하기 위해 다양한 해결책이 제안 되었고 가장 두드러지는 두 가지는 `관계형 모델` 과 `네트워크 모델` 이다.

**네트워크 모델**
코다실 모델이라고 불리기도 한다. 코다실 모델은 계층 모델을 일반화 하며, 계층 모델의 트리 구조와 다르게 레코드는 다중 부모가 있을 수 있다. 즉 `다대일` 과 `다대다` 관계를 모델링 가능하다.

네트워크 모델에서 레코드 간 연결은 외래 키보다는 프로그래밍 언어의 포인터와 비슷하며, 레코드에 접근하는 유일한 방법은 최상위 레코드에서부터 연속된 연결 경로를 따르는 방법(`접근 경로`) 이다.

가장 간단한 경우는 목록의 맨 앞에서 시작해서 원하는 레코드를 찾을 때까지 한 번에 하나의 레코드를 보는 방식이지만, 다대다 관계에선 다양한 다른 경로가 같은 레코드로 이어질 수 있어 다양한 접근 경로를 계속 추적해야 한다.

계층 모델과 네트워크 모델 모두, 원하는 데이터에 대한 경로가 없다면 어려운 상황에 놓이며, 아주 많은 수작업 데이터베이스 질의 코드를 살펴봐야 하고 새로운 접근 경로를 다루기 위해 재작성 해야한다.

**관계형 모델**
대관계형 모델은 임의 조건과 일치하는 테이블의 일부 또는 모든 로우를 선택해서 읽을 수 있고 일부 칼럼을 키로 지정해 칼럼과 일치하는 특정 로우를 읽을 수 있다.

RDB의 Optimizer는 질의의 어느 부분을 어떤 순서로 실행할지를 결정하고 사용할 색인을 자동으로 결정한다.  새로운 방식으로 데이터에 질의 하고 싶은 경우 새로운 색인을 선언하기만 하면 질의는 자동으로 가장 적합한 색인을 사용한다. 따라서 애플리케이션에 새로운 기능을 추가하는 작업이 훨씬 쉽다.

어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까

만일 데이터가 문서와 비슷한 구조라면 문서 모델을 사용하는 것이 좋다. 문서와 비슷한 구조를 여러 테이블로 나누어 찌는 관계형 기법은 다루기 힘든 스키마와 불필요하게 복잡한 코드를 발생시킨다.

하지만 애플리케이션에서 다대다 관계를 사용한다면 문서 모델은 매력이 떨어지며, 비정규화로 조인의 필요성 줄이기가 가능하지만, 일관성을 유지하기 위한 추가 작업이 필요하다. 일반적으로 어떤 모델이 더 애플리케이션을 간단하게 만드는지 말할 수 없다. 다만 데이터 항목 간에 존재하는 관계유형에 따라 다르다.

**문서 모델에서의 스키마 유연성**

대부분의 문서 데이터베이스와 관계형 데이터베이스에서 지원하는 JSON은 문서의 데이터에 어떤 스키마를 강요하지 않는다.

문서 데이터베이스는 종종 `스키마리스` 로 불리지만 데이터를 읽는 코드는 보통 구조의 유형을 어느정도 가정한다. 좀 더 정확하게는 `쓰기 스키마` 와 반대되는 `읽기 스키마` 이다.

읽기 스키마는 프로그래밍 언어에서 동적 타입 확인과 유사하고 쓰기 스키마의 경우 정적 타입 확인과 유사하다.  문서 데이터베이스에서는 새로운 필드를 가진 새로운 문서를 작성하고 애플리케이션에선 예전 문서를 읽은 경우를 처리하는 코드만 있으면 되지만, `정적 타입` 의 데이터 베이스 스키마에서는 보통 UPDATE .. SET등의 마이그레이션 작업을 수행한다.

읽기 스키마 접근 방식은 컬렉션 안의 항목이 어떤 이유로 모두 동일한 구조가 아닐 때 유리하며, 아래와 같은 이유가 있다.

- 각 유형의 오브젝트별로 자체 테이블에 넣는 방법은 실용적이지 않다.
- 사용자가 제어할 수 없고 언제나 변경 가능한 외부 시스템에 의해 데이터 구조가 결정된다.

**질의를 위한 데이터 지역성**

웹 페이지 상에 문서를 보여주는 동작처럼 애플리케이션이 자주 전체 문서에 접근해야 할 때 `저장소 지역성` 을 활용하면 성능 이점이 있다.

지역성의 이점은 한 번에 해당 문서의 많은 부분을 필요로 하는 경우에만 적용된다.  지역성을 위해 관련 데이터를 함께 그룹화하는 개념이 문서 모델에만 국한되지 않는다는 점이 중요하다.

**문서 데이터 베이스와 관계형 데이터베이스의 통합**

포스트그레스큐엘은 9.3 버전부터 마이 SQL은 5.7 버전 부터 JSON 문서에 대해 비슷한 수준의 지원 기능을 제공한다.

문서 데이터베스 쪽에서 본다면 리싱크 DB는 질의 언어에서 관계형 조인을 지원하고 몽고DB 드라이버는 자동으로 데이터 베이스 참조를 확인한다.

관계형 데이터베이스와 문서 데이터베이스는 시간이 지남에 따라 점점 비슷해 지고 있으며, 관계형 과 문서의 혼합 모델은 미래 데이터베이스들이 가야 할 길이다.