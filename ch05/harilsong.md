# 05장. 복제

- 단일 리더(single-leader)
- 다중 리더(multi-leader)
- 리더 없는 복제(leaderless)

## 5.1 리더와 팔로워

복제 서버(replica): 데이터베이스의 복사본을 저장하는 각 노드

데이터베이스의 모든 쓰기는 모든 복제 서버에서 처리돼야 한다: 그렇지 않으면 복제 서버는 더 이상 동일한 데이터를 유지할 수 없다.

리더 기반 복제: 모든 쓰기는 리더라는 특별한 복제 서버에 전달되고, 리더는 쓰기를 처리한 후 모든 팔로워에게 쓰기를 복제한다.

### 동기식 대 비동기식 복제

동기식 복제의 장점은 팔로워가 리더와 일관성 있게 최신 데이터 복사본을 가지는 것을 보장한다. 단점은 동기 팔로워가 응답하지 않는다면
쓰기가 처리될 수 없다는 것이다. 이런 이유로 모든 팔로워가 동기식인 상황은 비현실적이다. 임의 한 노드의 장애는 전체 시스템을 멈추게 한다.

보통 리더 기반 복제는 완전히 비동기식으로 구성한다. 이런 경우 리더가 잘못되고 복구할 수 없으면 팔로워에 아직 복제되지 않은 모든 쓰기는 유실된다.
하지만 모든 팔로워가 잘못되더라도 리더가 쓰기 처리를 계속 할 수 있는 장점이 있다.

### 새로운 팔로워 설정

1. 리더의 데이터베이스 스냅숏을 일정 시점에 가져온다.
2. 스냅숏을 새로운 팔로워 노드에 복사한다.
3. 팔로워는 리더에 연결해 스냅숏 이후 발생한 모든 데이터 변경을 요청한다.
4. 팔로워가 스냅숏 이후 데이터 변경의 backlog 를 모두 처리했을 때 따라잡았다고 말한다. 이제부터 리더에 발생하는 데이터 변화를 이어 처리할 수 있다.

### 노드 중단 처리

#### 팔로워 장애: 따라잡기 복구

각 팔로워는 리더로부터 수신한 데이터 변경 로그를 로컬 디스크에 보관한다.

1. 보관된 로그에서 결함이 발생하기 전에 처리한 마지막 트랜잭션을 알아낸다.
2. 팔로워는 리더에 연결해 팔로워 연결이 끊어진 동안 발생한 데이터 변경을 모두 요청한다.

#### 리더 장애: 장애 복구

1. 리더가 장애인지 판단한다.
2. 팔로워 중 하나가 새로운 리더가 되도록 선출한다.
3. 새로운 리더 사용을 위해 시스템을 재설정한다.

장애 복구 과정은 잘못될 수 있는 것 투성이다.

- 특정 결함 시나리오에서 두 노드가 모두 자신이 리더라고 믿을 수 있다. 이런 상황을 **스플릿 브레인(split brain)** 이라고 한다.
스플릿 브레인은 매우 위험한 상황이다. 두 노드가 동시에 쓰기를 수행하면 데이터가 불일치할 수 있다.
- 리더가 분명히 죽었다고 판단 가능한 적절한 타임아웃은 얼마일까?

### 복제 노드 구현

#### 구문 기반 복제

리더는 모든 쓰기 요청(**구문(statement)**)을 기록하고 쓰기를 실행한 다음 구문 로그를 팔로워에게 전송한다.

- MySQL 5.1 이전 버전에서 사용

#### 쓰기 전 로그 배송

일반적으로 모든 쓰기는 로그에 기록한다. 완전히 동일한 로그를 사용해 다른 노드에서 복제 서버를 구축할 수 있다.
리더는 디스크에 로그를 기록하는 일 외에도 팔로워에게 네트워크로 로그를 전송하기도 한다.

팔로워가 이 로그를 처리하면 리더에서 있는 것과 정확히 동일한 데이터 구조의 복제본이 만들어진다.

- PostgreSQL, Oracle 등에서 사용

단점은 로그가 제일 저수준의 데이터를 기술하기 때문에 복제가 저장소 엔진과 밀접하게 엮이게 된다. 저장소 형식을 다른 버전으로 변경한다면
대개 리더와 팔로워의 데이터베이스 소프트웨어 버전을 다르게 실행할 수 없다.

즉, 중단시간 없이 데이터베이스 소프트웨어 업그레이드 수행이 불가능하다.

#### 논리적(로우 기반) 로그 복제



#### 트리거 기반 복제

트리거는 사용자 정의 애플리케이션 코드를 등록할 수 있게 한다. 이 코드는 데이터베이스 시스템에서 데이터가 변경되면 자동으로 실행된다.

트리거 기반 복제에는 다른 복제 방식보다 많은 오버헤드가 있고 버그나 제한사항이 많지만, 유연성 때문에 매우 유용하다.

## 5.2 복제 지연 문제

### 자신이 쓴 내용 읽기

### 단조 읽기

### 일관된 순서로 읽기

### 복제 지연을 위한 해결책

## 5.3 다중 리더 복제

### 다중 리더 복제의 사용 사례

### 쓰기 충돌 다루기

### 다중 리더 복제 토폴로지

## 5.4 리더 없는 복제

### 노드가 다운됐을 때 데이터베이스에 쓰기

### 정족수 일관성의 한계

### 느슨한 정족수와 암시된 핸드오프

### 동시 쓰기 감지

## 정리
