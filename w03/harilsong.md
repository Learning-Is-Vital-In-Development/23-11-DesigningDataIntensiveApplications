# Ch2 데이터 모델과 질의 언어(데이터를 위한 질의 언어, 그래프형 데이터 모델)

## 데이터를 위한 질의 언어

SQL 은 선언형 언어로 목표를 달성하기 위한 방법이 아니라 알고자하는 데이터의 패턴, 즉 결과가 충족해야 하는 조건과 데이터를 어떻게 변환할지를 지정하기만 하면 된다. 

선언형 언어는 병렬 실행에 적합하다. 명령형 코드는 명령어를 특정 순서로 수행하게끔 지정하기 때문에 다중 코어나 장비에서 병렬처리가 매우 어렵다.

### 웹에서의 선언형 진의

CSS 선택자는 스타일을 적용하려는 엘리멘트의 패턴을 선언하는 방식으로 페이지를 조작할 수 있다. DOM API 를 사용하는 명령형 방식으로 한다면 같은 기능을 구현하려해도 엄청난 양의 코드가 필요하다. 자바스크립트 코드는 CSS 보다 이해하는데 더 오래 걸리고 어려울 뿐만 아니라 몇가지 심각한 문제가 있다.

- 페이지가 다시 로딩될 때까지 하이라이트 표시가 유지된다
- 성능 개선이 어렵다

### 맵리듀스 질의

대량의 데이터를 처리하기 위한 프로그래밍 모델

맵리듀스는 선언형 질의 언어도 완전한 명령어 질의 API 도 아닌 그 중간 정도에 있다. 질의 로직은 처리 프레임워크가 반복적으로 호출하는 조각 코드로 표현한다. 맵리듀스는 여러 함수형 프로그래밍 언어에 있는 map(collect 라고도 함)과 reduce(fold 나 inject 라고도 함) 함수를 기반으로 한다.

맵리듀스의 사용성 문제는 연계된 자바스크립트 함수 두 개를 신중하게 작성해야 한다는 점인데 이는 종종 하나의 질의를 작성하는 것보다 어렵다. 이런 이유로 몽고 DB 는 aggregation pipeline 이라 부르는 선언형 질의 언어 지원을 추가했다.

- Mongo DB 의 aggregation pipeline 은 라이브 환경에서는 추천되지 않는 기능

## 그래프형 데이터 모델

데이터에서 다대다 관계가 매우 일반적이라면 고려해볼 수 있는 모델

- 소셜 그래프: 정점은 사람이고 간선은 사람들이 서로 알고 있음을 나타낸다.
- 웹 그래프: 정점은 웹페이지이고 간선은 페이지들 사이의 링크를 나타낸다.
- 도로나 철도 네트워크: 정점은 교차로나 역이고 간선은 도로나 철도를 나타낸다.

### 속성 그래프

정점은 다음과 같은 요소로 구성된다.

- 고유한 식별자
- 유출(outgoing) 간선 집합
- 유입(incoming) 간선 집합
- 속성 컬렉션(키-값 쌍)

간선은 다음과 같은 요소로 구성된다.

- 고유한 식별자
- 간선이 시작하는 정점(꼬리 정점)
- 간선이 끝나는 정점(머리 정점)
- 두 정점 간 관계 유형을 설명하는 레이블
- 속성 컬렉션(키-값 쌍)

```postgresql
CREATE TABLE vertices (
    vertex_id  integer PRIMARY KEY,
    properties json
);

CREATE TABLE edges (
    edge_id    integer PRIMARY KEY,
    tail_vertex    integer REFERENCES vertices (vertex_id),
    head_vertex    integer REFERENCES vertices (vertex_id),
    label      text,
    properties json
);

CREATE INDEX edges_tail ON edges (tail_vertex);
CREATE INDEX edges_head ON edges (head_vertex);
```

이 모델의 몇 가지 중요한 면은 다음과 같다.

1. 정점은 다른 정점과 간선으로 연결된다. 특정 유형과 관련 여부를 제한하는 스키마는 없다.
2. 정점이 주어지면 정점의 유입과 유출 간선을 효율적으로 찾을 수 있고 그래프를 순회할 수 있다.
3. 다른 유형의 관계에 서로 다른 레이블을 사용하면 단일 그래프에 다른 유형의 정보를 저장하면서도 데이터 모델을 깔끔하게 유지할 수 있다.

### 사이퍼 질의 언어

**사이퍼(Cypher)** 는 속성 그래프를 위한 선언형 질의 언어

그래프 질의 언어를 사용할 필요성이 있을 때 다시 확인해봐도 될 것 같다.

### SQL 의 그래프 질의

그래프 데이터를 관계형 구조로 넣어도 SQL 을 사용할 수는 있지만 약간 어렵다. 동일한 질의를 하나의 질의언어는 4줄로 작성하고 다른 질의 언어는 29줄로 작성해야 한다는 점이다. 따라서 애플리케이션에 적합한 데이터 모델을 선택하는 작업은 중요하다.

### 트리플 저장소와 스파클

트리플 저장소 모델은 속성 그래프 모델과 거의 동등하다.

신박

#### 시맨틱 웹

#### RDF 데이터 모델

#### 스파클 질의 언어

### 초석: 데이터로그

**데이터로그(Datalog)** 는 스파클이나 사이퍼보다 훨씬 오래된 언어로 1980년대 학계에서 광범위하게 연구됐다. 소프트웨어 엔지니어들 사이에어는 잘 알려져 있지 않지만 그럼에도 중요한 이유는 이후 질의 언어의 기반이 되는 초석을 제공하기 때문이다. 실제로 일부 데이터 시스템에서 데이터로그를 사용한다. 예를 들어 캐스캘로그는 데이터로그의 구현체로서 하둡의 대용량 데이터셋에 질의를 위한 용도다.

## 정리

역사적으로 데이터를 하나의 큰 트리(계층 모델)로 표현하려고 노력했지만 다대다 관계를 표현하기에는 트리 구조가 적절하지 않았다. 이 문제를 해결하기 위해 관계형 모델이 고안됐다. 새롭게 등장한 비관계형 데이터저장소인 "NoSQL" 은 다음과 같은 두 가지 주요 갈래가 있다.

1. 문서 데이터베이스는 데이터가 문서 자체에 포함돼 있으면서 하나의 문서와 다른 문서 간 관계가 거의 없는 사용 사례를 대상으로 한다.
2. 그래프 데이터베이스는 문서 데이터베이스와는 정반대로 모든 것이 잠재적으로 관련 있다는 사용 사례를 대상으로 한다.

세 가지 모델(문서, 관계형, 그래프) 모두 현재 널리 사용하고 있으며 각 모델은 각자의 영역에서 훌륭하다. 한 모델을 다른 모델로 흉내 낼 수 있지만 그 결과는 대부분 엉망이다. 이것이 바로 **단일 만능 솔류션이 아닌 각기 목적에 맞는 다양한 시스템을 보유해야 하는 이유**다.
