# 데이터 모델과 질의 언어


## 데이터를 위한 질의언어

데이터를 질의하는 방법으로 크게 선언형 질의 언어와 명령형 질의 언어가 있다. 선언형 질의 언어의 경우 질의를 수행하는 방법이 아닌 알고자 하는 데이터의 특성을 지정한다. 이에 반해 명령형 질의는 코드와 같이 질의를 수행하는 방법을 스스로 작성해야 한다.

이러한 특징으로 선언형 질의는 데이터베이스가 실제 동작을 최적화 할 수 있는 쿼리 최적화기에 수행 방법의 결정 책임을 위임하게 된다. 이를 통해서 질의를 변경하지 않고도 질의를 최적화 할 수 있다. 또한 명령형의 경우 동작 방식에 따라서는 병렬 처리가 어려울 수 있다는 점에서 최근 CPU 성능과 코어 증가에 적절하게 대응하기 어려울 수 있다.

## 웹에서의 선언형 질의

웹에서 CSS 선택자는 선언형 질의를 따르고 있다. 이와 반대로 명령형으로 Javascript를 통해 DOM API로 조작하는 것으로 같은 목적을 달성할 수 있다. 하지만 CSS 선택자는 별도의 작업 없이도 웹 브라우저의 변경 감지에 따른 재적용이 자동으로 되는 반면 js 스크립트는 페이지 전체가 새롭게 로딩 되어서 새로 호출되기 전까지는 변경되지 않는다. 또한 새로운 기능이나 개선이 나오더라도 이를 적용하기 위해서는 코드를 다시 수정해주어야 한다.

## 맵리듀스 질의

맵과 리듀스를 활용한 대용량 데이터 처리를 위한 프로그래밍 도구이다. 앞서 말한 선언형과 명령형의 사이로 map과 reduce 함수만을 순수(pure)함수로 작성하여 데이터를 처리하고 결과를 얻어낸다. 순수함수로 작성되기 때문에 사이드 이펙트가 없어 실패 시 자유롭게 재시도할 수 있다.

몽고DB는 이러한 목적으로 집계 파이프라인(aggregation pipeline)이라고 부르는 선언형 질의 언어를 지원한다.

# 그래프형 데이터 모델

앞서 다대다 관계가 데이터 모델의 중요한 구분 기준이라는 것을 알게 되었다. 다대다 관계가 일반적이라면 그래프 모델 역시 데이터 모델로 고려할 수 있다. 그래프형 데이터 모델은 정점(vertex)와 간선(edge)로 구성된다.

일반적으로 같은 형태의 데이터에 대해서 정점으로 처리하고 이들의 관계를 표현하지만 다른 형태의 데이터들도 그래프형 모델로 표현할 수 있다.

이번 장에서는 **속성 그래프 모델**과 **트리플 저장소 모델**의 2가지 데이터 모델과 사이퍼(Cypher), 스파클(SPARQL), 데이터로그(DataLog)의 3가지 질의 언어에 대해서 설명한다.

## 속성 그래프

속성 그래프의 다음과 같이 정점과 간선이 구성된다. 정점은 식별자, 들어오는 간선 집합, 나가는 간선 집합, 속성 컬렉션(키밸류)으로 구성된다. 간선은 식별자, 간선이 시작하는 정점, 끝나는 정점, 관계 유형을 설명하는 레이블, 속성 컬렉션(키밸류)로 구성된다.

정점은 간선으로 구성되기 때문에 어떠한 관계에 대한 제약이 없다. 또한 정점을 통해 그래프를 순회할 수 있다. 여러 유형의 관계를 레이블로 처리하여 단일 그래프에서도 다양한 유형의 정보를 처리할 수 있다.

## 사이퍼 질의 언어

사이퍼 질의는 속성 그래프를 위한 선언형 질의이다. 아래 간단한 데이터 생성 질의이다.

```
CREATE
    (NAmerica:Location {name:'North America', type:'continent'}),
    (USA:Location {name:'United States', type:'contry'}),
    (Idaho:Location {name:'North Idaho', type:'state'}),
    (Lucy:Person {name:'Lucy'}),
    (Idaho) -[:WITHIN]-> (USA) -[:WITHIN]-> (NAmerica),
    (Lucy) -[:BORN_IN]-> (Idaho)
```

이제 “미국에서 유럽으로 이민 온 모든 사람들의 이름 찾기” 데이터 조회 질의를 해보자.

```
MATCH
    (person) -[:BORN_IN]-> () -[:WITHIN*0...]->(us:Location {name:"United States"}),
    (person) -[:LIVES_IN]-> () -[:WITHIN*0...]->(eu:Location {name:"Europe"})
RETURN person.name
```

United States라는 이름을 가진 로케이션 또는 WITHIN으로 찾을 수 있는 하위 로케이션에 태어나는 조건과 Europre 이라는 이름을 가진 로케이션 또는 WITHIN으로 찾을 수 있는 하위 로케이션에서 살았던 적이 있는 조건을 모두 만족하는 사람의 이름들이라고 해석할 수 있다.

이처럼 선언형 질의 언어는 구체적인 탐색 방법은 애플리케이션에게 위임한다.

## SQL의 그래프 질의

관계형 데이터베이스 그래프 데이터를 표현할 수 있다. 그렇다면 SQL로 어떻게 질의를 해야 할까? 재귀 공통 테이블 식을 사용해 표현할 수 있다. 하지만 아주 복잡하다. 따라서 데이터 모델을 적절하게 선택하는 것이 매우 중요하다.

## 트리플 저장소와 스파클

트리플 저장소는 속성 그래프 모델과 유사하다. 하지만 모든 정보를 주어, 서술어, 목적어라는 3가지 형태의 데이터로 저장한다. 그래프에서 주어는 정점이며 목적어가 정점이라면 서술형은 간선, 목적어가 값이라면 서술형은 동일함을 의미한다.

### 시맨틱 웹

트리플 관련된 글을 보다보면 시맨틱 웹이 자주 등장하지만 둘은 아주 독립적이다. 시맨틱 웹은 기계가 읽을 수 있도록 정보를 게시해보자라는 개념에서 출발하였다. 서로 다른 웹사이트가 일관된 형태로 데이터를 게시하기 위핸 자원 기술 프레임워크(Resource Description Framework, RDF) 제안되었다.

### RDF 데이터 모델

RDF는 인터넷 전체의 데이터 교환을 위해 설계하여 트리플의 주어와 서술어, 목적어는 주로 URI다.

### 스파클 질의 언어

스파클(SPARQL)은 RDF 데이터 모델을 사용한 트리플 저장소 질의 언어이다. 다음과 같이 위 예시를 스파클로 표현할 수 있다.

```
PREFIX : <uri:example:>

SELECT ?personName WHERE {
    ?person :name ?personName,
    ?person :bornIn / :within* / :name "United States".
    ?person :livesIN / :within* / :name "Europe".
}
```

## 초석: 데이터 로그

데이터로그는 스파클이나 사이퍼보다 훨씬 오래된 언어이다. 서술어(주어, 목적어) 형태로 작성한다. 한번에 질의하는 것이 아닌 단계를 나눠서 조금씩 질의를 한다.
